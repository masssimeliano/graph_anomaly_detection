name: Run Kaggle Notebook

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  run-kaggle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Kaggle CLI
        run: pip install kaggle

      - name: Set up Kaggle API credentials
        run: |
          mkdir -p ~/.kaggle
          echo "{\"username\":\"${{ secrets.KAGGLE_USERNAME }}\",\"key\":\"${{ secrets.KAGGLE_KEY }}\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Push notebook to Kaggle
        run: kaggle kernels push -p src/notebook/

      - name: Get Notebook ID
        id: getid
        run: |
          NOTEBOOK_ID=$(kaggle kernels list --user ${{ secrets.KAGGLE_USERNAME }} --sort-by dateCreated | grep train_check | head -n 1 | awk '{print $2}')
          echo "NOTEBOOK_ID=$NOTEBOOK_ID" >> $GITHUB_ENV

      - name: Wait for notebook to complete
        run: |
          echo "Waiting for notebook: $NOTEBOOK_ID"
          for i in {1..60}; do
            STATUS=$(kaggle kernels status $NOTEBOOK_ID | grep 'status')
            echo "Current status: $STATUS"
            if [ "$STATUS" = "complete" ]; then
              break
            elif [ "$STATUS" = "error" ]; then
              echo "Notebook failed"
              exit 1
            fi
            sleep 30
          done

      - name: Download output files
        run: kaggle kernels output $NOTEBOOK_ID --path output

      - name: Upload output to GitHub artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kaggle-notebook-output
          path: output/